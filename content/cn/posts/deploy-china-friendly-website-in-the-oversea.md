---
title: "如何部署全球网络友好型站点"
date: 2020-04-27
categories: ['技术']
draft: true
---

由于众所周知的原因，中国的互联网与国际互联网是严重割裂的。墙内的人访问一个墙外的网站首先存在能不能访问通的问题，其次还有能不能访问地快的问题，墙外的人访问墙的网站虽然一般都能访问地通但往往速度也非常慢。

在很长一段时间里，如果我们希望部署一个能够被全球包括中国都能够快速访问的网站/App，都是一件异常困难的事情。几年前由于国内对网站托管的管理越来越严格，我把自己所有东西都迁出了国外。但这几年一直会有国内的朋友来反馈访问我的网站非常慢，虽然我心底不怎么 care 甚至想过要让所有国内的解析都解析到 127.0.0.1，但被频繁地问道总归会非常心烦，所以这期间探索了一系列如何在维持一个「自由身」的情况下，尽可能加快国内用户的访问速度。

这里需要先明确两点常识：

1. 无论你用任何方法，你都无法实现在域名不备案的情况下，把服务部署/托管在一个国内的服务器上，如果有，那理论上就是非法的。
2. 绝大部分国外 CDN 服务提供商都不提供中国区的加速服务，而有极少数有中国节点的 CDN 服务提供商(如 Cloudflare )也不会在对个人不审核的情况下开放中国节点的 CDN 加速（因为违反了第一条）。

本文完全旨在介绍在合乎国内外法律的范围内，通过技术优化来「尽可能」提升我们网站的全球访问体验。

无论是 App 还是网站，总结来说主要包含以下内容：

- 静态 .html 文件
- .js/.css/media 静态文件
- API 接口 / 动态渲染的 .html

先说静态 html 文件，虽然其也属于静态资源且可被托管在 CDN 节点上，但由于上面说的第二点存在，我们无法做到把 `example.com/index.html` 部署在一个国内的 CDN 节点上，且这个域名还不需要备案。所以这个文件只能被部署在一个中国用户访问的足够快的海外 CDN 上。可供选择的有 Github Pages, Netlify, now.sh, CloudFlare 等，但根据我的不完全测试，Github Pages 是目前最简单也是速度最快的。目前 Pages 使用的 CDN 服务是 [Fastly](https://www.fastly.com/customers/github，中国地区访问 Github Pages 基本上都是走的美国节点。

接下来是所有除 html 外的静态文件。对于静态资源而言，我们其实是无所谓这个域名是不是我们自己的，所以我们完全可以利用其他服务已经备案的域名来访问我们的静态资源。[jsdelivr](https://www.jsdelivr.com/network#map) 是一个用来托管 npm, github 上的静态资源的CDN服务，它在中国由网宿来提供 CDN 节点。我们只需要将所有静态资源上传到 github 上，就能以如 `https://cdn.jsdelivr.net/gh/joway/homepage/analytics.js` 这种形式访问到我们要的资源。完成这一步，我们就能够做到至少对于静态资源，体验和国内网站一模一样。

再说 API 接口或动态渲染的 html，这两者都牵涉到需要有一个平台部署后端。而上面说的 jsdelivr 也只能代理静态资源，其他能够代理动态内容的 CDN 服务也不对用户提供不需要备案的国内节点加速服务。所以在这种情况下，我们只能选择一个对国内外用户都友好的服务器机房来部署后端。目前观察下来，阿里云香港的节点算是一个最友好的机房。这里还有一个问题，出于各种原因，我们可能会更偏爱使用如 AWS/heroku 这种服务来部署我们的业务，即便如此也没有关系，我们可以使用阿里云香港的节点反向代理我们在 AWS/heroku 上的服务，并且配置 DNS 解析，让所有中国地区的用户解析到阿里云香港，而海外的解析到原始地址，从而实现一个私人定制的 CDN。目前使用这种方案几个月下来，效果非常好。
 

